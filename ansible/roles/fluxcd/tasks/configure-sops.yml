---
#Configure SOPS
- name: Create SOPS directory
  ansible.builtin.file:
    path: "{{ talos_config_dir }}/secrets/sops"
    state: directory
    mode: '0700'
  become: yes

- name: Check if age key already exists
  ansible.builtin.stat:
    path: "{{ talos_config_dir }}/secrets/sops/age.agekey"
  register: agekey_file

- name: Generate age key (only if missing)
  ansible.builtin.command:
    cmd: age-keygen -o "{{ talos_config_dir }}/secrets/sops/age.agekey"
  when: not agekey_file.stat.exists
  changed_when: true

- name: Read age public key (robust)
  ansible.builtin.shell: |
    set -euo pipefail
    awk '/public key:/ {print $NF; exit}' "{{ talos_config_dir }}/secrets/sops/age.agekey"
  args:
    executable: /bin/bash
  register: age_public_key
  changed_when: false

- name: Show age public key (use this in .sops.yaml)
  ansible.builtin.debug:
    msg: "SOPS age public key: {{ age_public_key.stdout }}"

- name: Ensure flux-system namespace exists
  ansible.builtin.command:
    cmd: kubectl get ns flux-system
  changed_when: false

- name: Create/Update SOPS age secret in flux-system
  ansible.builtin.shell: |
    kubectl -n flux-system create secret generic sops-age \
      --from-file=age.agekey={{ talos_config_dir }}/secrets/sops/age.agekey \
      --dry-run=client -o yaml | kubectl apply -f -
  args:
    executable: /bin/bash
  changed_when: true

- name: Create .sops.yaml in GitOps repo root
  ansible.builtin.copy:
    dest: "{{ talos_config_dir }}/../.sops.yaml"
    mode: '0644'
    content: |
      creation_rules:
        - path_regex: .*secret.*\.ya?ml$
          encrypted_regex: "^(data|stringData)$"
          age: "{{ age_public_key.stdout }}"