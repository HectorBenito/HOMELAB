# 1. El Transport para saltarse el SSL (Asegúrate de que no tenga campos extra)
apiVersion: traefik.io/v1alpha1
kind: ServersTransport
metadata:
  name: proxmox-lan-transport
  namespace: traefik
spec:
  insecureSkipVerify: true
  disableHTTP2: true
---
# 2. Los Services y Endpoints (Sin Selectores)
apiVersion: v1
kind: Service
metadata:
  name: pve1-svc
  namespace: traefik
spec:
  ports: [{name: https, port: 8006, targetPort: 8006}]
---
apiVersion: v1
kind: Endpoints
metadata:
  name: pve1-svc
  namespace: traefik
subsets:
  - addresses: [{ip: "192.168.110.11"}]
    ports: [{port: 8006, name: https}]
---
apiVersion: v1
kind: Service
metadata:
  name: pve2-svc
  namespace: traefik
spec:
  ports: [{name: https, port: 8006, targetPort: 8006}]
---
apiVersion: v1
kind: Endpoints
metadata:
  name: pve2-svc
  namespace: traefik
subsets:
  - addresses: [{ip: "192.168.110.12"}]
    ports: [{port: 8006, name: https}]
---
apiVersion: v1
kind: Service
metadata:
  name: pve3-svc
  namespace: traefik
spec:
  ports: [{name: https, port: 8006, targetPort: 8006}]
---
apiVersion: v1
kind: Endpoints
metadata:
  name: pve3-svc
  namespace: traefik
subsets:
  - addresses: [{ip: "192.168.110.13"}]
    ports: [{port: 8006, name: https}]
---
# 3. El Ingress con la corrección de Scheme y Transport
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: proxmox-lan-ingress
  namespace: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    # ESTO EVITA EL 503: Indica que el backend es HTTPS
    traefik.ingress.kubernetes.io/service.serversscheme: https
    # ESTO EVITA EL 500: Vincula el skip-verify
    traefik.ingress.kubernetes.io/service.serverstransport: traefik-proxmox-lan-transport@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - "*.local.nasbenito.com"
      secretName: wildcard-local-tls
  rules:
  - host: pve1.local.nasbenito.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: pve1-svc
            port: {number: 8006}
  - host: pve2.local.nasbenito.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: pve2-svc
            port: {number: 8006}
  - host: pve3.local.nasbenito.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: pve3-svc
            port: {number: 8006}