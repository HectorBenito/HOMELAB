apiVersion: batch/v1
kind: Job
metadata:
  name: minio-bootstrap-cnpg-backups
  namespace: minio
spec:
  backoffLimit: 6
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: mc
          image: minio/mc:latest
          command: ["/bin/sh", "-lc"]
          env:
            - name: MINIO_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: minio-root
                  key: rootUser
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: minio-root
                  key: rootPassword
            - name: CNPG_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-cnpg-user
                  key: accessKey
            - name: CNPG_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-cnpg-user
                  key: secretKey
          args:
            - |
              set -euo pipefail

              echo "[*] Waiting for MinIO service to be ready..."
              # Espera hasta 3 minutos a que MinIO acepte credenciales (alias set)
              for i in $(seq 1 36); do
                if mc alias set local http://minio.minio.svc.cluster.local:9000 "${MINIO_ROOT_USER}" "${MINIO_ROOT_PASSWORD}" >/dev/null 2>&1; then
                  echo "[OK] MinIO reachable and credentials accepted"
                  break
                fi
                echo "  - not ready yet (${i}/36), sleeping 5s..."
                sleep 5
              done

              # Si después del bucle no funciona, fallamos explícito (para logs claros)
              mc alias set local http://minio.minio.svc.cluster.local:9000 "${MINIO_ROOT_USER}" "${MINIO_ROOT_PASSWORD}"

              echo "[*] Creating bucket (idempotent)"
              mc mb --ignore-existing local/cnpg-backups

              echo "[*] Writing policy file"
              cat >/tmp/cnpg-policy.json <<'EOF'
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": ["s3:ListBucket"],
                    "Resource": ["arn:aws:s3:::cnpg-backups"],
                    "Condition": {
                      "StringLike": {
                        "s3:prefix": ["pg-main/*"]
                      }
                    }
                  },
                  {
                    "Effect": "Allow",
                    "Action": [
                      "s3:GetObject",
                      "s3:PutObject",
                      "s3:DeleteObject",
                      "s3:AbortMultipartUpload",
                      "s3:ListMultipartUploadParts"
                    ],
                    "Resource": ["arn:aws:s3:::cnpg-backups/pg-main/*"]
                  }
                ]
              }
              EOF

              echo "[*] Creating policy (tolerate already-exists)"
              (mc admin policy create local cnpg-pg-main /tmp/cnpg-policy.json || mc admin policy add local cnpg-pg-main /tmp/cnpg-policy.json || true)

              echo "[*] Creating user (tolerate already-exists)"
              mc admin user add local "${CNPG_ACCESS_KEY}" "${CNPG_SECRET_KEY}" || true

              echo "[*] Attaching policy to user (tolerate already-attached)"
              (mc admin policy attach local cnpg-pg-main --user "${CNPG_ACCESS_KEY}" || mc admin policy set local cnpg-pg-main user="${CNPG_ACCESS_KEY}" || true)

              echo "[OK] Bucket + user/policy preparados"
